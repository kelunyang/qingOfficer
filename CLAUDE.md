# 清代官員數據可視化系統 - 開發文檔

## 項目概述
這是一個基於 Vue 3 + D3.js 的清代官員數據可視化系統，用於分析和展示清代官員的職業生涯、機構組成、地區流動等數據。

## 開發環境
- **操作系統**: WSL2 (Windows Subsystem for Linux)
- **Web 服務器**: Caddy
- **前端框架**: Vue 3 + Vite
- **UI 組件庫**: Element Plus
- **可視化庫**: D3.js
- **狀態管理**: Pinia

## 部署架構

### 生產環境
- **URL**: http://172.19.40.233/qingOfficer
- **部署方式**: 
  1. 運行 `npm run build` 構建生產版本
  2. 構建產物會自動連結 CSV 數據文件
  3. Caddy 服務器提供靜態文件服務

### 開發環境
由於項目運行在 WSL + Caddy 環境中，開發流程需要特別注意：

#### ⚠️ 重要提示
- **VS Code 中的開發服務器無法直接訪問**
- **必須使用生產構建進行測試**

#### 開發流程
```bash
# 1. 進入前端目錄
cd /mnt/f/Development/qingOfficer/frontend

# 2. 開發時修改代碼後，構建生產版本
npm run build

# 3. 在瀏覽器中訪問測試
# http://172.19.40.233/qingOfficer
```

#### 替代開發方式
如果需要熱重載開發，可以考慮：
```bash
# 修改 vite.config.js 中的 server 配置
server: {
  host: '0.0.0.0',  # 允許外部訪問
  port: 3000,
  open: false       # 不自動打開瀏覽器
}

# 然後通過 WSL IP 訪問
# http://[WSL_IP]:3000/qingOfficer
```

## 項目結構
```
qingOfficer/
├── frontend/                 # Vue 前端應用
│   ├── src/
│   │   ├── components/      # Vue 組件
│   │   │   ├── OfficialCareerDrawer.vue      # 官員職務查詢抽屜
│   │   │   ├── RegionalOfficialDrawer.vue    # 機構官員篩選抽屜
│   │   │   ├── RegionalOfficialChart.vue     # 機構官員組成圖表
│   │   │   ├── CareerPathChart.vue           # 職務路徑分析圖表
│   │   │   ├── RegionalFlowChart.vue         # 地區流動分析圖表
│   │   │   └── CareerAlluvialChart.vue       # 職業生涯路徑圖表
│   │   ├── stores/          # Pinia 狀態管理
│   │   ├── utils/           # 工具函數
│   │   └── App.vue         # 主應用組件
│   ├── dist/               # 構建輸出目錄
│   └── package.json
├── output/                 # CSV 數據文件
└── dta/                   # 原始 Stata 數據文件
```

## 核心功能

### 1. 機構官員組成分析
- **檔案**: `RegionalOfficialChart.vue`
- **抽屜**: `RegionalOfficialDrawer.vue`
- **功能**: 分析各機構中官員的出身和旗分組成
- **特色**: 新增詳細篩選器，解決原本 dropdown 選項過多的問題

### 2. 職務路徑分析
- **檔案**: `CareerPathChart.vue`
- **功能**: 展示官員出身與職務路徑的關係

### 3. 地區流動分析
- **檔案**: `RegionalFlowChart.vue`
- **功能**: 分析官員在不同地區間的任職流動

### 4. 職業生涯路徑
- **檔案**: `CareerAlluvialChart.vue`
- **抽屜**: `OfficialCareerDrawer.vue`
- **功能**: 使用 Alluvial 圖展示官員職業生涯流動路徑

## 最近更新

### 2024-12-XX: 過濾器儲存功能
- **新功能**: "儲存過濾器" & "載入過濾器" - 永久保存圖表篩選設定
- **使用流程**:
  1. 在任何圖表中設定篩選條件後，點擊頂欄 "儲存過濾器" 按鈕
  2. 過濾器設定會自動儲存到瀏覽器 localStorage
  3. 點擊 "載入過濾器" 可查看所有已儲存的設定
  4. 選擇要載入的過濾器，會自動切換到對應圖表並套用設定
- **技術特色**:
  - **按數據集區分**: 不同數據集的過濾器設定不會互相干擾
  - **完整狀態儲存**: 包含所有篩選條件、顯示模式、統計選項
  - **智能切換**: 載入時自動切換到對應的圖表 tab
  - **時間戳記錄**: 顯示儲存時間，按時間排序
- **技術實現**:
  - 在 `dataStore.js` 中添加 localStorage 管理功能
  - 為所有圖表組件添加 `getFilterState()` 和 `setFilterState()` 方法
  - 在 `App.vue` 中添加儲存/載入介面和過濾器管理抽屜
  - 支援新增、載入、刪除過濾器設定

### 2024-12-XX: 鎖定統計名單功能
- **新功能**: "鎖定統計名單" - 追蹤特定群體的跨圖表分析
- **使用流程**:
  1. 在任何圖表中使用篩選器後，頂欄出現 "鎖定統計名單" 按鈕
  2. 點擊鎖定後，該人員名單會被固定
  3. 切換到其他圖表時，都只顯示這群人的數據
  4. 所有篩選器被禁用，確保分析對象一致
- **技術實現**:
  - 在 `dataStore.js` 中添加鎖定狀態管理
  - 使用 `effectiveData` 計算屬性提供當前有效數據
  - 在 `App.vue` 中添加 el-alert 提示和控制按鈕
  - 修改所有圖表組件支持鎖定模式，禁用篩選器
- **適用場景**: 比較特定群體在不同維度（機構組成、職務路徑、地區流動、生涯軌跡）的表現

### 2024-12-XX: 機構官員組成篩選器優化
- **問題**: 原本的 dropdown menu 選項太多，不夠好用
- **解決方案**: 參考"職業生涯路徑"的 el-drawer 實作方式
- **新增功能**:
  - 創建 `RegionalOfficialDrawer.vue` 組件
  - 提供更豐富的篩選選項（姓氏、名字、機構、官職、地區、旗分、出身、PersonUID）
  - 使用表格形式展示官員記錄
  - 支持無限滾動載入
  - 支持選擇/取消選擇官員並重畫圖表

## 開發注意事項

### CSS 樣式
- 使用 Element Plus 的設計系統
- 支援列印模式（黑白圖案紋理）
- 響應式設計

### 數據處理
- CSV 文件通過符號連結方式提供
- 支援多個數據集切換
- 使用 PersonUID 作為官員唯一標識

### 圖表輸出
- 支援 SVG 和 PNG 格式輸出
- 支援列印友好的黑白模式
- 多種配色主題

## 故障排除

### 常見問題
1. **開發服務器無法訪問**: 使用 `npm run build` 後訪問生產版本
2. **數據未載入**: 檢查 CSV 文件是否正確連結到 dist 目錄
3. **圖表未顯示**: 檢查瀏覽器控制台是否有 JavaScript 錯誤

### 調試建議
- 使用瀏覽器開發者工具查看網絡請求
- 檢查控制台是否有錯誤信息
- 確認數據文件路徑正確

## 技術債務和改進建議
1. 考慮添加 Docker 容器化部署
2. 優化大數據集的加載性能
3. 增加單元測試覆蓋率
4. 考慮添加數據緩存機制